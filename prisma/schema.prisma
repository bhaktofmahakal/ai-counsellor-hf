generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String      @id @default(cuid())
  email               String      @unique
  password            String?
  name                String?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  education           String?
  degree              String?
  gpa                 String?
  studyGoal           String?
  targetField         String?
  preferredCountries  String[]    @default([])
  budgetMin           Int         @default(0)
  budgetMax           Int         @default(0)
  examStatus          String?
  examScores          String?
  onboardingCompleted Boolean     @default(false)
  fundingPlan         String?     // Self-funded, Scholarship, Loan
  sopStatus           String?     // Not started, Draft, Ready
  targetIntake        String?     // Fall 2025, Spring 2026, etc.
  currentStage        Int         @default(1)
  lockedUniversityId  String?
  avatar              String?
  resetToken          String?     // OTP or Token for password reset
  resetTokenExpiry    DateTime?   // Expiry for the reset token
  shortlists          Shortlist[]
  tasks               Task[]
  documents           Document[]

  @@index([email])
}

model University {
  id             String      @id @default(cuid())
  name           String
  location       String?
  country        String
  rank           Int?
  tuition        Int
  acceptanceRate String?
  matchScore     Int         @default(0)
  tags           String[]    @default([])
  programs       String[]    @default([])
  description    String?
  risks          String[]    @default([])
  strengths      String[]    @default([])
  website        String?
  domain         String?
  
  // Phase 3 & 4 additions
  deadlines      String?     @default("December 1st") // For Phase 4 tracking
  costOfLiving   Int?        @default(15000)
  avgSalary      Int?        @default(75000)
  
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  shortlists     Shortlist[]

  @@index([country])
  @@index([name])
}

model Document {
  id        String   @id @default(cuid())
  userId    String
  title     String   // e.g., "Main SOP", "Resume 2026"
  type      String   // SOP, RESUME, LOR, TRANSCRIPT
  content   String   @db.Text
  status    String   @default("draft") // draft, review, ready
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

model Shortlist {
  id           String     @id @default(cuid())
  userId       String
  universityId String
  createdAt    DateTime   @default(now())
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, universityId])
  @@index([userId])
}

model Task {
  id        String   @id @default(cuid())
  userId    String
  title     String
  description String?
  completed Boolean  @default(false)
  priority  String   @default("medium")
  due       String?
  stage     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stage])
}

model Conversation {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @default("default")
  title     String?  @default("New Conversation")
  role      String
  content   String
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}
